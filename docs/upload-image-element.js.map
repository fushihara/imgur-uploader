{"version":3,"file":"upload-image-element.js","sourceRoot":"","sources":["../src/upload-image-element.ts"],"names":[],"mappings":"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","sourcesContent":["import { 画像をimgurlにアップロードする } from \"./utils.js\";\r\n\r\nconst emptyGif = \"data:image/gif;base64,R0lGODlhAQABAIAAAAUEBAAAACwAAAAAAQABAAACAkQBADs=\";\r\nexport class UploadImageElement extends HTMLElement {\r\n  private アップロードステータス: \"アップロード前\" | \"アップロード中\" | \"アップロード完了\" | \"エラー\" = \"アップロード前\";\r\n  private ファイルのblob: Blob;\r\n  private elements: {\r\n    self: HTMLElement,\r\n    画像: HTMLImageElement\r\n    progress: HTMLProgressElement,\r\n    link: HTMLAnchorElement,\r\n    percent: HTMLElement,\r\n    resolution: HTMLElement,\r\n    extension: HTMLElement\r\n  }\r\n  private 画像データ: {\r\n    画像ファイル: Blob,\r\n    mime: string\r\n  } | null = null;\r\n  private 画像のURL: string | null = null;\r\n  constructor() {\r\n    super();\r\n    const shadowRoot = this.attachShadow({ mode: \"closed\" });\r\n    shadowRoot.innerHTML = `\r\n    <style>\r\n    * {\r\n      word-break: break-all;\r\n      box-sizing: border-box;\r\n    }\r\n      :host{\r\n       display:block; \r\n       width:270px;\r\n       height:200px;\r\n       border:solid 2px black;\r\n       margin:2px;\r\n      }\r\n    </style>\r\n    <div style=\"display: flex;flex-direction: column;height:100%;\">\r\n      <div style=\"flex:1 1 0;background-color:silver;overflow: hidden;padding:2px;\">\r\n        <img src=\"${emptyGif}\" style=\"width: 100%;height: 100%;object-fit: contain;\">\r\n      </div>\r\n      <div style=\"flex:0 0 20px;overflow: hidden;display:flex;justify-content: center;font-size:small;position: relative;\">\r\n        <progress id=\"progress\" style=\"position: absolute;top: 0;width: 100%;height: 100%;\"></progress>\r\n        <div style=\"z-index:1;display:flex;width: 100%;justify-content: space-evenly;\">\r\n          <a id=\"link\" href=\"\">2Eqlfza.jpg</a>\r\n          <span id=\"percent\">12%</span>\r\n          <span id=\"resolution\">1000x1000</span>\r\n          <span id=\"extension\">gif</span>\r\n        </div>\r\n      </div>\r\n    </div> \r\n    <div style=\"display:none;color:red;\" id=\"error-area\">\r\n    </div>\r\n  `;\r\n    this.elements = {\r\n      self: this,\r\n      画像: shadowRoot.querySelector<HTMLImageElement>(\"img\")!,\r\n      progress: shadowRoot.querySelector<HTMLProgressElement>(\"#progress\")!,\r\n      link: shadowRoot.querySelector<HTMLAnchorElement>(\"#link\")!,\r\n      percent: shadowRoot.querySelector<HTMLElement>(\"#percent\")!,\r\n      resolution: shadowRoot.querySelector<HTMLElement>(\"#resolution\")!,\r\n      extension: shadowRoot.querySelector<HTMLElement>(\"#extension\")!,\r\n    }\r\n    this.elements.progress.style.display = \"none\";\r\n    this.elements.link.style.display = \"none\";\r\n    this.elements.percent.style.display = \"none\";\r\n    this.elements.resolution.style.display = \"none\";\r\n    this.elements.extension.style.display = \"none\";\r\n  }\r\n  async 画像のファイルをセット(画像のblob: Blob, mime: string, アップロードに使うapiToken: string): Promise<string> {\r\n    if (this.アップロードステータス != \"アップロード前\") {\r\n      throw new Error(`アップロード済みです`);\r\n    }\r\n    const imageBase64 = await new Promise<string>(resolve => {\r\n      const fr = new FileReader();\r\n      fr.onload = () => {\r\n        // onload内ではe.target.resultにbase64が入っているのであとは煮るなり焼くなり\r\n        const base64 = fr.result as \"\";\r\n        resolve(base64);\r\n      };\r\n      fr.readAsDataURL(画像のblob);\r\n    });\r\n    await new Promise(resolve => {\r\n      this.elements.画像.onload = () => {\r\n        resolve();\r\n      };\r\n      this.elements.画像.src = imageBase64;\r\n    });\r\n    const 解像度 = `${this.elements.画像.naturalWidth}x${this.elements.画像.naturalHeight}`;\r\n    this.elements.resolution.innerText = 解像度;\r\n    this.elements.resolution.style.display = \"\";\r\n    this.elements.percent.innerText = \"wait\";\r\n    this.elements.percent.style.display = \"\";\r\n    this.elements.extension.innerText = mime;\r\n    this.elements.extension.style.display = \"\";\r\n    this.画像データ = {\r\n      画像ファイル: 画像のblob,\r\n      mime: mime\r\n    };\r\n    this.アップロードステータス = \"アップロード中\";\r\n    if (アップロードに使うapiToken == \"\") {\r\n      this.アップロードステータス = \"エラー\";\r\n      this.elements.self.title = \"apiトークンが未指定です\";\r\n      this.elements.self.style.borderColor = \"red\";\r\n      return Promise.reject();\r\n    }\r\n    try {\r\n      const アップロードした画像のurl = await 画像をimgurlにアップロードする(画像のblob, アップロードに使うapiToken);\r\n      this.elements.link.innerText = アップロードした画像のurl.match(/.+\\/(.+)/)![1];\r\n      this.elements.link.href = アップロードした画像のurl;\r\n      this.elements.link.style.display = \"\";\r\n      this.elements.percent.style.display = \"none\";\r\n      this.アップロードステータス = \"アップロード完了\";\r\n      this.elements.self.style.borderColor = \"blue\";\r\n      this.画像のURL = アップロードした画像のurl;\r\n      return アップロードした画像のurl;\r\n    } catch (e) {\r\n      this.アップロードステータス = \"エラー\";\r\n      this.elements.self.title = e;\r\n      this.elements.self.style.borderColor = \"red\";\r\n      return Promise.reject();\r\n    }\r\n  }\r\n  アップロードした画像のURLかnullを取得(): string | null {\r\n    return this.画像のURL;\r\n  }\r\n}\r\ncustomElements.define(\"upload-image\", UploadImageElement);"]}